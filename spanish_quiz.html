<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Vocab Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Balsamiq+Sans:wght@700&display=swap');
        
        /* Custom Styles for Game Aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3ff; /* Very light lavender background */
        }

        .game-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .card {
            background-color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .level-button, .option-button, .restart-button {
            font-family: 'Balsamiq Sans', cursive;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 0 rgba(0, 0, 0, 0.1);
            border: 2px solid;
        }

        .level-button:hover, .restart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 0 rgba(0, 0, 0, 0.15);
        }

        .option-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 0 rgba(0, 0, 0, 0.1);
            opacity: 0.9;
        }

        .correct {
            background-color: #4ade80 !important; /* Green 400 */
            border-color: #16a34a !important; /* Green 600 */
            color: white !important;
        }

        .incorrect {
            background-color: #f87171 !important; /* Red 400 */
            border-color: #dc2626 !important; /* Red 600 */
            color: white !important;
        }

        .disabled {
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- Custom Message Box (Replaces alert()) -->
    <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <p id="message-content" class="text-xl font-semibold text-gray-800 mb-4"></p>
            <button onclick="hideMessage()" class="p-3 w-full rounded-lg bg-purple-500 text-white hover:bg-purple-600 font-bold transition duration-150 ease-in-out">OK</button>
        </div>
    </div>
    
    <div id="game-container" class="game-container">
        
        <!-- Game Card -->
        <div id="quiz-card" class="card w-full max-w-lg p-6 md:p-10 rounded-xl">
            
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-6 text-center" style="font-family: 'Balsamiq Sans', cursive;">
                Spanish Vocab Quiz
            </h1>

            <!-- Screen: Difficulty Selection -->
            <div id="level-selection-screen">
                <p class="text-center text-lg text-gray-600 mb-8">
                    Select your school year level to begin:
                </p>
                <div class="space-y-4">
                    <button onclick="startGame(1)" class="level-button w-full p-4 rounded-lg bg-yellow-400 text-yellow-900 border-yellow-600">
                        Year 1 (Beginner)
                    </button>
                    <button onclick="startGame(2)" class="level-button w-full p-4 rounded-lg bg-blue-400 text-blue-900 border-blue-600">
                        Year 2 (Intermediate)
                    </button>
                    <button onclick="startGame(3)" class="level-button w-full p-4 rounded-lg bg-pink-400 text-pink-900 border-pink-600">
                        Year 3 (Advanced)
                    </button>
                </div>
            </div>

            <!-- Screen: Quiz Display -->
            <div id="quiz-screen" class="hidden">
                <div class="flex justify-between items-center mb-6 text-xl font-bold">
                    <span id="score-display" class="text-purple-600">Score: 0</span>
                    <span id="question-count" class="text-gray-500">Q: 1/10</span>
                </div>

                <!-- Question Area -->
                <div class="bg-purple-100 p-6 rounded-lg text-center mb-8 shadow-inner">
                    <p class="text-lg text-purple-700 font-semibold mb-2">Translate this word:</p>
                    <p id="word-to-translate" class="text-4xl font-bold text-purple-800" style="font-family: 'Balsamiq Sans', cursive;">WORD</p>
                </div>

                <!-- Options Area -->
                <div id="options-container" class="grid grid-cols-1 gap-4 md:grid-cols-2">
                    <!-- Option buttons will be injected here -->
                </div>
                
                <!-- Feedback Message -->
                <div id="feedback-message" class="mt-6 text-center text-xl font-bold h-6"></div>

                <!-- AI Context Feature -->
                <div id="ai-context-area" class="mt-8">
                    <button id="context-button" onclick="requestContext()" class="hidden w-full p-3 rounded-lg bg-purple-600 text-white font-bold hover:bg-purple-700 transition duration-150 ease-in-out disabled:opacity-50">
                        ✨ Get Contextual Sentence
                    </button>
                    <div id="context-output" class="mt-4 p-4 bg-purple-50 rounded-lg text-sm italic text-gray-700 hidden text-left shadow-inner border border-purple-200"></div>
                    <div id="loading-indicator" class="text-center mt-4 hidden text-purple-500 font-semibold">
                        <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generating context...
                    </div>
                </div>
            </div>

            <!-- Screen: Results -->
            <div id="results-screen" class="hidden text-center">
                <h2 class="text-3xl font-bold text-purple-700 mb-4" style="font-family: 'Balsamiq Sans', cursive;">Quiz Complete!</h2>
                <p class="text-xl text-gray-700 mb-6">You scored:</p>
                <p id="final-score" class="text-6xl font-extrabold text-green-600 mb-8">0/10</p>
                <button onclick="resetGame()" class="restart-button p-4 rounded-lg bg-red-500 text-white border-red-700 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.91 8.91 0 0118 9.776zM12 21V3" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.32 12.733v.013a9 9 0 0015.356 2.091M12 21V3" />
                    </svg>
                    Try Another Level
                </button>
            </div>
            
        </div>
    </div>

    <script type="module">
        // --- Gemini API Configuration and Helper ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
        const API_KEY = ""; // Placeholder for Canvas environment

        /**
         * Robust fetch wrapper with exponential backoff for retries.
         */
        async function exponentialBackoffFetch(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) { 
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }

        // --- Game Data (Vocabulary) ---
        const ALL_VOCABULARY = [
            // Year 1 (Level 1: Basic Nouns, Greetings, Colors)
            { english: "Hello", spanish: "Hola", level: 1 },
            { english: "Goodbye", spanish: "Adiós", level: 1 },
            { english: "Dog", spanish: "Perro", level: 1 },
            { english: "Cat", spanish: "Gato", level: 1 },
            { english: "Water", spanish: "Agua", level: 1 },
            { english: "Red", spanish: "Rojo", level: 1 },
            { english: "Blue", spanish: "Azul", level: 1 },
            { english: "Table", spanish: "Mesa", level: 1 },
            { english: "Chair", spanish: "Silla", level: 1 },
            { english: "Book", spanish: "Libro", level: 1 },
            { english: "Apple", spanish: "Manzana", level: 1 },
            { english: "House", spanish: "Casa", level: 1 },

            // Year 2 (Level 2: Common Verbs, Places, Weather)
            { english: "To eat", spanish: "Comer", level: 2 },
            { english: "To drink", spanish: "Beber", level: 2 },
            { english: "To work", spanish: "Trabajar", level: 2 },
            { english: "To sleep", spanish: "Dormir", level: 2 },
            { english: "School", spanish: "Escuela", level: 2 },
            { english: "Library", spanish: "Biblioteca", level: 2 },
            { english: "Summer", spanish: "Verano", level: 2 },
            { english: "Winter", spanish: "Invierno", level: 2 },
            { english: "Rain", spanish: "Lluvia", level: 2 },
            { english: "Money", spanish: "Dinero", level: 2 },
            { english: "Tomorrow", spanish: "Mañana", level: 2 },
            { english: "Yesterday", spanish: "Ayer", level: 2 },

            // Year 3 (Level 3: Abstract Concepts, Advanced Verbs, Conjunctions)
            { english: "To develop", spanish: "Desarrollar", level: 3 },
            { english: "To involve", spanish: "Involucrar", level: 3 },
            { english: "Environment", spanish: "Medio ambiente", level: 3 },
            { english: "Opportunity", spanish: "Oportunidad", level: 3 },
            { english: "However", spanish: "Sin embargo", level: 3 },
            { english: "Although", spanish: "Aunque", level: 3 },
            { english: "Knowledge", spanish: "Conocimiento", level: 3 },
            { english: "Society", spanish: "Sociedad", level: 3 },
            { english: "Government", spanish: "Gobierno", level: 3 },
            { english: "Experience", spanish: "Experiencia", level: 3 },
            { english: "Difficult", spanish: "Difícil", level: 3 },
            { english: "Important", spanish: "Importante", level: 3 },
        ];
        
        // --- Game State Variables ---
        let currentLevel = 0;
        let score = 0;
        let questionIndex = 0;
        let quizData = []; // Shuffled list of questions for the current game
        const MAX_QUESTIONS = 10;
        let lastCorrectSpanishWord = ''; // Stores the word for the AI context feature
        
        // --- Utility Functions ---

        /**
         * Shows a custom modal message box. (Replaces alert())
         * @param {string} text - The message to display.
         */
        function showMessage(text) {
            document.getElementById('message-content').textContent = text;
            document.getElementById('message-box').classList.remove('hidden');
        }

        /**
         * Hides the custom modal message box.
         */
        window.hideMessage = () => {
            document.getElementById('message-box').classList.add('hidden');
        }

        /**
         * Shuffles an array in place using the Fisher-Yates algorithm.
         * @param {Array<any>} array - The array to shuffle.
         * @returns {Array<any>} The shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Gets three distinct incorrect Spanish options for the current question.
         * @param {string} correctAnswer - The Spanish word that is correct.
         * @param {number} level - The current difficulty level.
         * @returns {Array<string>} An array of three incorrect Spanish options.
         */
        function getIncorrectOptions(correctAnswer, level) {
            // Get all Spanish words from the selected level that are NOT the correct answer
            const pool = ALL_VOCABULARY
                .filter(item => item.level === level && item.spanish !== correctAnswer)
                .map(item => item.spanish);
            
            // If the pool is too small, use words from other levels for variety/filler
            if (pool.length < 3) {
                 const fillerPool = ALL_VOCABULARY
                    .filter(item => item.spanish !== correctAnswer)
                    .map(item => item.spanish);
                 
                 // Get 3 random unique words from the filler pool
                 const uniqueFiller = shuffleArray(fillerPool).slice(0, 3);
                 return uniqueFiller;

            } else {
                // Shuffle the level-specific pool and pick 3
                return shuffleArray(pool).slice(0, 3);
            }
        }

        // --- Gemini API Feature: Contextual Sentence Generation ---

        window.requestContext = async () => {
            const contextButton = document.getElementById('context-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const contextOutput = document.getElementById('context-output');

            contextButton.classList.add('disabled');
            contextButton.disabled = true; // Use standard attribute for true disabling
            loadingIndicator.classList.remove('hidden');
            contextOutput.classList.add('hidden');
            contextOutput.textContent = '';

            const word = lastCorrectSpanishWord;

            const systemPrompt = "You are a friendly Spanish tutor. Generate a single, interesting Spanish sentence using the provided word. Include the English translation in parentheses at the end of the sentence. The sentence must be concise, grammatically correct, and appropriate for a student learning the language.";
            const userQuery = `Use the Spanish word: "${word}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await exponentialBackoffFetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    contextOutput.textContent = text;
                    contextOutput.classList.remove('hidden');
                } else {
                    contextOutput.textContent = "Could not generate context. Try again!";
                    contextOutput.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Gemini API call failed:", error);
                showMessage("Connection error while requesting context. Please try again.");
                contextOutput.textContent = "Error loading context.";
                contextOutput.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                contextButton.classList.remove('disabled');
                contextButton.disabled = false;
            }
        };


        // --- Core Game Logic ---

        window.startGame = (level) => {
            currentLevel = level;
            score = 0;
            questionIndex = 0;
            
            // 1. Filter vocabulary by selected level
            const availableVocab = ALL_VOCABULARY.filter(item => item.level === level);

            // Check if there are enough words for the quiz
            if (availableVocab.length < MAX_QUESTIONS) {
                console.error(`Not enough vocabulary for level ${level}. Found ${availableVocab.length}, need ${MAX_QUESTIONS}.`);
                showMessage('Error: Not enough unique vocabulary words for this quiz size. Please try another level.'); 
                return;
            }

            // 2. Shuffle and select the required number of questions
            quizData = shuffleArray(availableVocab).slice(0, MAX_QUESTIONS);
            
            // 3. Update UI to Quiz Screen
            document.getElementById('level-selection-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');

            loadQuestion();
        }

        function loadQuestion() {
            if (questionIndex >= MAX_QUESTIONS) {
                showResults();
                return;
            }

            const currentQ = quizData[questionIndex];
            const correctSpanish = currentQ.spanish;
            const optionsContainer = document.getElementById('options-container');
            
            // Clear previous state and feedback
            optionsContainer.innerHTML = '';
            document.getElementById('feedback-message').textContent = '';

            // Hide context features when loading a new question
            document.getElementById('context-button').classList.add('hidden');
            document.getElementById('context-button').disabled = false;
            document.getElementById('context-output').classList.add('hidden');
            document.getElementById('loading-indicator').classList.add('hidden');


            // Update score and question count display
            document.getElementById('score-display').textContent = `Score: ${score}`;
            document.getElementById('question-count').textContent = `Q: ${questionIndex + 1}/${MAX_QUESTIONS}`;
            
            // Display the word to translate
            document.getElementById('word-to-translate').textContent = currentQ.english;

            // Generate options (1 correct + 3 incorrect)
            const incorrectOptions = getIncorrectOptions(correctSpanish, currentLevel);
            const allOptions = shuffleArray([...incorrectOptions, correctSpanish]);

            // Create buttons for options
            allOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'option-button w-full p-4 rounded-lg bg-gray-100 text-gray-800 border-gray-300 font-bold text-lg';
                button.onclick = () => checkAnswer(option, correctSpanish);
                optionsContainer.appendChild(button);
            });
        }

        window.checkAnswer = (selectedOption, correctSpanish) => {
            const isCorrect = selectedOption === correctSpanish;
            const options = document.querySelectorAll('.option-button');
            const feedbackMessage = document.getElementById('feedback-message');

            // Disable all buttons to prevent double-clicking
            options.forEach(btn => btn.classList.add('disabled'));

            // Provide visual feedback
            options.forEach(btn => {
                if (btn.textContent === correctSpanish) {
                    btn.classList.add('correct');
                    btn.classList.remove('bg-gray-100', 'border-gray-300');
                } else if (btn.textContent === selectedOption) {
                    btn.classList.add('incorrect');
                    btn.classList.remove('bg-gray-100', 'border-gray-300');
                }
            });

            // Update score and message
            if (isCorrect) {
                score++;
                feedbackMessage.textContent = "¡Correcto! Well done.";
                feedbackMessage.classList.remove('text-red-500');
                feedbackMessage.classList.add('text-green-600');
            } else {
                feedbackMessage.textContent = `Incorrecto. The answer was "${correctSpanish}".`;
                feedbackMessage.classList.remove('text-green-600');
                feedbackMessage.classList.add('text-red-500');
            }

            // --- LLM Feature Activation ---
            lastCorrectSpanishWord = correctSpanish; // Store the word for context generation
            document.getElementById('context-button').classList.remove('hidden');

            // Move to the next question after a delay
            questionIndex++;
            setTimeout(loadQuestion, 2500); // Increased delay slightly to allow user to click context button
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            
            const finalScoreElement = document.getElementById('final-score');
            finalScoreElement.textContent = `${score}/${MAX_QUESTIONS}`;
            
            // Update color based on performance
            if (score >= MAX_QUESTIONS * 0.9) {
                finalScoreElement.classList.remove('text-yellow-600', 'text-red-600');
                finalScoreElement.classList.add('text-green-600');
            } else if (score >= MAX_QUESTIONS * 0.5) {
                finalScoreElement.classList.remove('text-green-600', 'text-red-600');
                finalScoreElement.classList.add('text-yellow-600');
            } else {
                finalScoreElement.classList.remove('text-green-600', 'text-yellow-600');
                finalScoreElement.classList.add('text-red-600');
            }

            document.getElementById('results-screen').classList.remove('hidden');
        }

        window.resetGame = () => {
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('level-selection-screen').classList.remove('hidden');
            score = 0;
            questionIndex = 0;
            quizData = [];
            currentLevel = 0;

            // Reset score color (just in case)
             document.getElementById('final-score').classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
             document.getElementById('final-score').classList.add('text-green-600');
        }
    </script>

</body>
</html>
